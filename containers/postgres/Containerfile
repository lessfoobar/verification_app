# Base image
FROM quay.io/fedora/fedora:latest

# Metadata
LABEL maintainer="verification-service@example.com"
LABEL description="PostgreSQL container with SSL certs and multi-user security"

# Environment variables
ENV PGDATA=/var/lib/pgsql/data
ENV CERTS_DIR=/etc/ssl/postgresql

# Install PostgreSQL and dependencies
RUN dnf install -y postgresql-server postgresql-contrib openssl && \
    dnf clean all && \
    rm -rf /var/cache/dnf

# Create postgres user and required directories
RUN mkdir -p $PGDATA $CERTS_DIR /migrations /configs && \
    chown -R postgres:postgres $PGDATA $CERTS_DIR /migrations /configs && \
    chmod 700 $PGDATA && \
    chmod 755 $CERTS_DIR

# Copy SSL certificates (these will be generated by the Makefile)
COPY --chown=root:root --chmod=444 certs/ca.crt /etc/ssl/ca.crt
COPY --chown=postgres:postgres --chmod=444 certs/server.crt $CERTS_DIR/server.crt
COPY --chown=postgres:postgres --chmod=400 certs/server.key $CERTS_DIR/server.key

# Copy configuration files
COPY --chown=postgres:postgres --chmod=400 pg_hba.conf postgresql.conf /configs/

# Copy database migrations
COPY --chown=postgres:postgres --chmod=400 migrations/ /migrations/

# Copy and set permissions for entrypoint script
COPY --chown=root:root --chmod=555 entrypoint.sh /usr/local/bin/entrypoint.sh

# Switch to postgres user
USER postgres

# Set working directory
WORKDIR /var/lib/pgsql

# Expose PostgreSQL port
EXPOSE 5432

# Create volume for persistent data
VOLUME ["$PGDATA"]

# Use entrypoint script
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]